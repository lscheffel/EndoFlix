<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>EndoFlick - Video Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        body { overflow: hidden; }
        .divider { width: 5px; background: #555; cursor: pointer; }
        .playlist-frame { transition: width 0.3s; }
        .players-frame { transition: width 0.3s; }
        .video-js { width: 100%; height: 100%; }
        .video-container { position: relative; }
        .error-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: red; text-align: center; padding-top: 50px; display: none; }
    </style>
</head>
<body class="bg-dark text-light">
    <header class="p-2 bg-secondary d-flex justify-content-between">
        <h1 class="h5 m-0">EndoFlick - Video Player</h1>
        <div>
            <input type="checkbox" id="themeToggle" class="me-2">
            <a href="#" class="text-light me-2">Sobre</a>
            <a href="#" class="text-light">Ajuda</a>
        </div>
    </header>
    <div class="d-flex" style="height: calc(100vh - 50px);">
        <div class="players-frame" id="playersFrame" style="width: 60%;">
            <div class="row h-100 m-0">
                <div class="col-6 p-1 video-container">
                    <video id="player1" class="video-js vjs-default-skin" controls preload="auto">
                        <source id="source1" type="video/mp4">
                        <p class="vjs-no-js">Para ver este vídeo, habilite o JavaScript e considere atualizar para um navegador web que suporte vídeo HTML5.</p>
                    </video>
                    <div class="error-overlay" id="error1">Erro ao carregar o vídeo.</div>
                </div>
                <div class="col-6 p-1 video-container">
                    <video id="player2" class="video-js vjs-default-skin" controls preload="auto">
                        <source id="source2" type="video/mp4">
                        <p class="vjs-no-js">Para ver este vídeo, habilite o JavaScript e considere atualizar para um navegador web que suporte vídeo HTML5.</p>
                    </video>
                    <div class="error-overlay" id="error2">Erro ao carregar o vídeo.</div>
                </div>
                <div class="col-6 p-1 video-container">
                    <video id="player3" class="video-js vjs-default-skin" controls preload="auto">
                        <source id="source3" type="video/mp4">
                        <p class="vjs-no-js">Para ver este vídeo, habilite o JavaScript e considere atualizar para um navegador web que suporte vídeo HTML5.</p>
                    </video>
                    <div class="error-overlay" id="error3">Erro ao carregar o vídeo.</div>
                </div>
                <div class="col-6 p-1 video-container">
                    <video id="player4" class="video-js vjs-default-skin" controls preload="auto">
                        <source id="source4" type="video/mp4">
                        <p class="vjs-no-js">Para ver este vídeo, habilite o JavaScript e considere atualizar para um navegador web que suporte vídeo HTML5.</p>
                    </video>
                    <div class="error-overlay" id="error4">Erro ao carregar o vídeo.</div>
                </div>
            </div>
        </div>
        <div class="divider" id="divider"></div>
        <div class="playlist-frame" id="playlistFrame" style="width: 40%;">
            <div class="p-2">
                <input type="text" id="folderInput" class="form-control mb-2" placeholder="Digite o caminho da pasta (ex.: C:\Videos)">
                <button onclick="scanFolder()" class="btn btn-primary mb-2">Carregar Pasta</button>
                <select id="playlistSelect" class="form-select mb-2">
                    <option value="">Selecionar Playlist</option>
                </select>
                <input type="text" id="filterInput" class="form-control mb-2" placeholder="Filtrar por nome">
                <select id="sortSelect" class="form-select mb-2">
                    <option value="name">A-Z</option>
                    <option value="date">Data</option>
                </select>
                <ul id="fileList" class="list-group mb-2" style="max-height: 50vh; overflow-y: auto;"></ul>
                <button id="savePlaylist" class="btn btn-primary mb-2">Salvar Playlist</button>
                <button id="clearCache" class="btn btn-danger">Limpar Cache</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
        videojs.options.flash.swf = "https://vjs.zencdn.net/8.10.0/video-js.swf";

        const playersFrame = document.getElementById('playersFrame');
        const playlistFrame = document.getElementById('playlistFrame');
        const divider = document.getElementById('divider');
        let isPlaylistVisible = true;

        const players = [
            videojs('player1', { controls: true, preload: 'auto' }),
            videojs('player2', { controls: true, preload: 'auto' }),
            videojs('player3', { controls: true, preload: 'auto' }),
            videojs('player4', { controls: true, preload: 'auto' })
        ];

        divider.addEventListener('click', () => {
            if (isPlaylistVisible) {
                playlistFrame.style.width = '0';
                playersFrame.style.width = '100%';
            } else {
                playlistFrame.style.width = '40%';
                playersFrame.style.width = '60%';
            }
            isPlaylistVisible = !isPlaylistVisible;
        });

        document.getElementById('themeToggle').addEventListener('change', (e) => {
            document.body.classList.toggle('bg-light', e.target.checked);
            document.body.classList.toggle('bg-dark', !e.target.checked);
            document.body.classList.toggle('text-dark', e.target.checked);
            document.body.classList.toggle('text-light', !e.target.checked);
        });

        async function scanFolder() {
            const folder = document.getElementById('folderInput').value.trim();
            if (!folder) {
                alert('Digite o caminho da pasta!');
                return;
            }
            const response = await fetch('/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder })
            });
            const data = await response.json();
            if (data.files) {
                updateFileList(data.files);
            } else {
                alert('Erro: ' + data.error);
            }
        }

        async function loadPlaylists() {
            const response = await fetch('/playlists');
            const playlists = await response.json();
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Selecionar Playlist</option>';
            for (const name in playlists) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        }

        document.getElementById('playlistSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                fetch('/playlists').then(res => res.json()).then(playlists => {
                    updateFileList(playlists[e.target.value]);
                });
            }
        });

        document.getElementById('savePlaylist').addEventListener('click', async () => {
            const name = prompt('Nome da playlist:');
            if (name) {
                const files = Array.from(document.querySelectorAll('#fileList li')).map(li => li.dataset.path);
                await fetch('/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, files })
                });
                loadPlaylists();
            }
        });

        document.getElementById('clearCache').addEventListener('click', async () => {
            await fetch('/clear_cache', { method: 'POST' });
            alert('Cache limpo!');
        });

        document.getElementById('filterInput').addEventListener('input', (e) => {
            const filter = e.target.value.toLowerCase();
            const items = document.querySelectorAll('#fileList li');
            items.forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(filter) ? '' : 'none';
            });
        });

        document.getElementById('sortSelect').addEventListener('change', (e) => {
            const files = Array.from(document.querySelectorAll('#fileList li')).map(li => ({
                path: li.dataset.path,
                text: li.textContent
            }));
            if (e.target.value === 'name') {
                files.sort((a, b) => a.text.localeCompare(b.text));
            } else {
                files.sort((a, b) => a.path.localeCompare(b.path));
            }
            updateFileList(files.map(f => f.path));
        });

        function updateFileList(files) {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            files.forEach(file => {
                const li = document.createElement('li');
                li.className = 'list-group-item draggable';
                li.draggable = true;
                li.dataset.path = file;
                li.textContent = file.split(/[\\/]/).pop();
                li.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', file);
                });
                list.appendChild(li);
            });
        }

        document.querySelectorAll('.video-container').forEach((container, index) => {
            const player = players[index];
            const source = document.getElementById(`source${index + 1}`);
            const errorOverlay = document.getElementById(`error${index + 1}`);
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const file = e.dataTransfer.getData('text/plain');
                const videoUrl = `/video/${encodeURIComponent(file)}`;
                if (player.src() !== videoUrl) {
                    source.setAttribute('src', videoUrl);
                    player.src({ type: 'video/mp4', src: videoUrl });
                    player.load();
                    player.on('loadeddata', () => player.play().catch(err => {
                        console.error('Erro ao tocar:', err);
                        errorOverlay.style.display = 'block';
                        setTimeout(() => errorOverlay.style.display = 'none', 5000);
                    }));
                }
            });
            container.addEventListener('dragover', (e) => e.preventDefault());
        });

        loadPlaylists();
    </script>
</body>
</html>