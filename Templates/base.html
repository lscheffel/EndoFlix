<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>EndoFlick - Video Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { overflow: hidden; }
        .divider { width: 10px; background: #555; cursor: pointer; }
        .divider:hover { background: #777; }
        .playlist-frame { transition: width 0.3s; max-width: 24%; min-width: 24%; overflow-x: hidden; }
        .players-frame { transition: width 0.3s; }
        .video-container { position: relative; }
        .video-player { object-fit: contain; }
        .error-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: red; text-align: center; padding-top: 50px; display: none; }
    </style>
</head>
<body class="bg-dark text-light">
    <header class="p-2 bg-secondary d-flex justify-content-between">
        <h1 class="h5 m-0">EndoFlick - Video Player</h1>
        <div>
            <input type="checkbox" id="themeToggle" class="me-2">
            <a href="#" class="text-light me-2">Sobre</a>
            <a href="#" class="text-light">Ajuda</a>
        </div>
    </header>
    <div class="d-flex" style="height: calc(100vh - 50px);">
        <div class="players-frame" id="playersFrame" style="width: 76%;">
            <div class="row h-100 m-0">
                <div class="col-6 p-1 video-container">
                    <video class="video-player" id="player1" controls preload="auto">
                        <source id="source1" type="video/mp4">
                        <div class="error-overlay" id="error1">Erro ao carregar o vídeo.</div>
                    </video>
                </div>
                <div class="col-6 p-1 video-container">
                    <video class="video-player" id="player2" controls preload="auto">
                        <source id="source2" type="video/mp4">
                        <div class="error-overlay" id="error2">Erro ao carregar o vídeo.</div>
                    </video>
                </div>
                <div class="col-6 p-1 video-container">
                    <video class="video-player" id="player3" controls preload="auto">
                        <source id="source3" type="video/mp4">
                        <div class="error-overlay" id="error3">Erro ao carregar o vídeo.</div>
                    </video>
                </div>
                <div class="col-6 p-1 video-container">
                    <video class="video-player" id="player4" controls preload="auto">
                        <source id="source4" type="video/mp4">
                        <div class="error-overlay" id="error4">Erro ao carregar o vídeo.</div>
                    </video>
                </div>
            </div>
        </div>
        <div class="divider" id="divider"></div>
        <div class="playlist-frame" id="playlistFrame" style="width: 24%;">
            <div class="p-2">
                <input type="text" id="folderInput" class="form-control mb-2" placeholder="Digite o caminho da pasta (ex.: C:\Videos)">
                <button onclick="scanFolder()" class="btn btn-primary mb-2">Carregar Pasta</button>
                <select id="playlistSelect" class="form-select mb-2">
                    <option value="">Selecionar Playlist</option>
                </select>
                <input type="text" id="filterInput" class="form-control mb-2" placeholder="Filtrar por nome">
                <select id="sortSelect" class="form-select mb-2">
                    <option value="name">A-Z</option>
                    <option value="date">Data</option>
                </select>
                <ul id="fileList" class="list-group mb-2" style="max-height: 50vh; overflow-y: auto;"></ul>
                <button id="savePlaylist" class="btn btn-primary mb-2">Salvar Playlist</button>
                <button id="clearCache" class="btn btn-danger">Limpar Cache</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const playersFrame = document.getElementById('playersFrame');
        const playlistFrame = document.getElementById('playlistFrame');
        const divider = document.getElementById('divider');
        const videoContainers = document.querySelectorAll('.video-container');
        let isPlaylistVisible = true;

        function updatePlayerSizes() {
            const frameWidth = playersFrame.offsetWidth;
            const playerWidth = frameWidth / 2; // 2 colunas no layout 2x2
            const playerHeight = playerWidth * 9 / 16; // Proporção 16:9

            videoContainers.forEach(container => {
                container.style.width = `${playerWidth}px`;
                container.style.height = `${playerHeight}px`;
                container.querySelector('.video-player').style.width = `${playerWidth}px`;
                container.querySelector('.video-player').style.height = `${playerHeight}px`;
            });

            // Forçar o layout 2x2
            videoContainers.forEach(container => {
                container.classList.remove('col-12');
                container.classList.add('col-6');
            });
        }

        divider.addEventListener('click', () => {
            if (isPlaylistVisible) {
                playlistFrame.style.minWidth = '0';
                playlistFrame.style.maxWidth = '0';
                playlistFrame.style.width = '0';
                playersFrame.style.width = '100%';
                divider.style.background = '#777';
            } else {
                playlistFrame.style.minWidth = '24%';
                playlistFrame.style.maxWidth = '24%';
                playlistFrame.style.width = '24%';
                playersFrame.style.width = '76%';
                divider.style.background = '#555';
            }
            isPlaylistVisible = !isPlaylistVisible;
            setTimeout(updatePlayerSizes, 300);
        });

        window.addEventListener('resize', updatePlayerSizes);

        document.getElementById('themeToggle').addEventListener('change', (e) => {
            document.body.classList.toggle('bg-light', e.target.checked);
            document.body.classList.toggle('bg-dark', !e.target.checked);
            document.body.classList.toggle('text-dark', e.target.checked);
            document.body.classList.toggle('text-light', !e.target.checked);
        });

        async function scanFolder() {
            const folder = document.getElementById('folderInput').value.trim();
            if (!folder) {
                alert('Digite o caminho da pasta!');
                return;
            }
            const response = await fetch('/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder })
            });
            const data = await response.json();
            if (data.files) {
                updateFileList(data.files);
                console.log('Arquivos carregados:', data.files); // Debug
            } else {
                alert('Erro: ' + (data.error || 'Falha ao carregar a pasta'));
                console.error('Erro na resposta:', data.error); // Debug
            }
        }

        async function loadPlaylists() {
            const response = await fetch('/playlists');
            const playlists = await response.json();
            const select = document.getElementById('playlistSelect');
            select.innerHTML = '<option value="">Selecionar Playlist</option>';
            for (const name in playlists) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        }

        document.getElementById('playlistSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                fetch('/playlists').then(res => res.json()).then(playlists => {
                    updateFileList(playlists[e.target.value]);
                });
            }
        });

        document.getElementById('savePlaylist').addEventListener('click', async () => {
            const name = prompt('Nome da playlist:');
            if (name) {
                const files = Array.from(document.querySelectorAll('#fileList li')).map(li => li.dataset.path);
                await fetch('/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, files })
                });
                loadPlaylists();
            }
        });

        document.getElementById('clearCache').addEventListener('click', async () => {
            await fetch('/clear_cache', { method: 'POST' });
            alert('Cache limpo!');
        });

        document.getElementById('filterInput').addEventListener('input', (e) => {
            const filter = e.target.value.toLowerCase();
            const items = document.querySelectorAll('#fileList li');
            items.forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(filter) ? '' : 'none';
            });
        });

        document.getElementById('sortSelect').addEventListener('change', (e) => {
            const files = Array.from(document.querySelectorAll('#fileList li')).map(li => ({
                path: li.dataset.path,
                text: li.textContent
            }));
            if (e.target.value === 'name') {
                files.sort((a, b) => a.text.localeCompare(b.text));
            } else {
                files.sort((a, b) => a.path.localeCompare(b.path));
            }
            updateFileList(files.map(f => f.path));
        });

        function updateFileList(files) {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            if (files && files.length > 0) {
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item draggable';
                    li.draggable = true;
                    li.dataset.path = file;
                    li.textContent = file.split(/[\\/]/).pop();
                    li.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', file);
                    });
                    list.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = 'Nenhum arquivo encontrado';
                list.appendChild(li);
            }
        }

        document.querySelectorAll('.video-player').forEach((player, index) => {
            const source = document.getElementById(`source${index + 1}`);
            const errorOverlay = document.getElementById(`error${index + 1}`);
            player.parentElement.addEventListener('drop', (e) => {
                e.preventDefault();
                const file = e.dataTransfer.getData('text/plain');
                const videoUrl = `/video/${encodeURIComponent(file)}`;
                if (player.src !== videoUrl) {
                    source.src = videoUrl;
                    player.load();
                    player.onloadeddata = () => player.play().catch(err => {
                        console.error('Erro ao tocar:', err);
                        errorOverlay.style.display = 'block';
                        setTimeout(() => errorOverlay.style.display = 'none', 5000);
                    });
                }
            });
            player.parentElement.addEventListener('dragover', (e) => e.preventDefault());

            // Adicionar suporte ao fullscreen nativo
            player.addEventListener('dblclick', () => {
                if (player.requestFullscreen) {
                    player.requestFullscreen();
                } else if (player.webkitRequestFullscreen) { // Safari
                    player.webkitRequestFullscreen();
                } else if (player.msRequestFullscreen) { // IE11
                    player.msRequestFullscreen();
                }
            });
        });

        loadPlaylists();
        updatePlayerSizes();
    </script>
</body>
</html>